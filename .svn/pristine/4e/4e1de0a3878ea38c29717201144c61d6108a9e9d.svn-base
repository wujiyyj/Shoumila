//
//  MJMenuViewController.m
//  侧滑菜单
//
//  Created by apple on 14-5-27.
//  Copyright (c) 2014年 itcast. All rights reserved.
//

#import "RYGMenuViewController.h"
#import "MBProgressHUD+MJ.h"
#import "RYGGrandeMarkView.h"
#import "RYGUserCenterViewController.h"
#import "RYGPersonalUserModel.h"
#import "UIImageView+RYGWebCache.h"
#import "RYGAddTargetViewController.h"
#import "RYGSettingViewController.h"
#import "RYGUserDetailParam.h"
#import "RYGHttpRequest.h"
#import "RYGPersonalCenterModel.h"

@interface RYGMenuViewController ()
@property(nonatomic,strong) NSMutableArray  *data;
@property(nonatomic,strong) NSString        *plistPath;
@property(nonatomic,strong) RYGPersonalUserModel *user;
@property(nonatomic) UITableView *menuTableView;
@end

@implementation RYGMenuViewController{
    UIButton *selectBtn;
}
- (void)viewDidLoad
{
    [super viewDidLoad];
    UIImageView *backgroundView = [[UIImageView alloc]initWithImage:[UIImage imageNamed:@"background"]];
    backgroundView.frame = CGRectMake(0, 0, RYGMenuWidth, SCREEN_HEIGHT);
    [self.view addSubview:backgroundView];
    [[NSNotificationCenter defaultCenter]addObserver:self selector:@selector(setUp) name:MENU_ITEMS object:nil];
    [self setUp];
}

- (void)loadUser{
    RYGUserDetailParam *userDetailParam = [RYGUserDetailParam param];
    userDetailParam.userid = [RYGUtility getUserInfo].userid;
    [RYGHttpRequest postWithURL:User_Personal_center params:userDetailParam.keyValues success:^(id json) {
        
        NSMutableDictionary *dic = [json valueForKey:@"data"];
        RYGPersonalCenterModel *personalCenterModel = [RYGPersonalCenterModel objectWithKeyValues:dic];
        _user = personalCenterModel.user;
    } failure:^(NSError *error) {
        
    }];
}

- (void)setUp{
    if ([RYGUtility validateUserLogin]) {
        [self loadUser];
    }
    _plistPath = [[NSBundle mainBundle] pathForResource:@"MenuItem" ofType:@"plist"];
    _data = [[NSMutableArray alloc] initWithContentsOfFile:_plistPath];
    UIImageView *icon = [[UIImageView alloc]initWithFrame:CGRectMake(45*SCREEN_SCALE, 64*SCREEN_SCALE, 70*SCREEN_SCALE, 70*SCREEN_SCALE)];
    icon.layer.cornerRadius = icon.width/2;
    icon.layer.borderWidth = 3;
    icon.layer.masksToBounds = YES;
    icon.userInteractionEnabled = YES;
    icon.layer.borderColor = ColorGreen.CGColor;
    [icon setImageURLStr:_user.user_logo placeholder:[UIImage imageNamed:@"user_head"]];
    UITapGestureRecognizer *recognizer = [[UITapGestureRecognizer alloc]initWithTarget:self action:@selector(userCenterAction)];
    [icon addGestureRecognizer:recognizer];
    [self.view addSubview:icon];
    
    UILabel *name = [[UILabel alloc]initWithFrame:CGRectMake(0, CGRectGetMaxY(icon.frame)+10, RYGMenuWidth/2, 14)];
    name.textAlignment = NSTextAlignmentRight;
    name.textColor = [UIColor whiteColor];
    name.text = _user.user_name;
    name.font = [UIFont systemFontOfSize:14];
    name.left = (name.text.length - 2)*7;
    [self.view addSubview:name];
    UIButton *level = [[UIButton alloc]initWithFrame:CGRectMake(CGRectGetMaxX(name.frame)+5, name.top+2, 30*SCREEN_SCALE, 11*SCREEN_SCALE)];
    level.backgroundColor = [UIColor redColor];
    level.layer.cornerRadius = 2;
    NSString *score = [NSString stringWithFormat:@"LV%@",_user.score];
    [level setTitle:score forState:UIControlStateNormal];
    level.titleLabel.font = [UIFont systemFontOfSize:10];
    [self.view addSubview:level];
    RYGGrandeMarkView *grandMarkView = [[RYGGrandeMarkView alloc]initWithFrame:CGRectMake(0, 0, RYGMenuWidth, 20)];
    grandMarkView.integralRank = _user.score;
    grandMarkView.center = CGPointMake(RYGMenuWidth/2, CGRectGetMaxY(level.frame)+15);
    [self.view addSubview:grandMarkView];
    for (int i = 1; i<=4; i++) {
        UIView *lastBtn = [self.view viewWithTag:i];
        if (lastBtn) {
            [lastBtn removeFromSuperview];
        }

    }
    [_data enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) {
        UIButton *menuBtn = [[UIButton alloc]initWithFrame:CGRectMake(14*SCREEN_SCALE, CGRectGetMaxY(grandMarkView.frame)+40*idx+40*SCREEN_SCALE, 130*SCREEN_SCALE, 40)];
        NSDictionary *dic = obj;
        [menuBtn setTitle:[dic valueForKey:@"name"] forState:UIControlStateNormal];
        menuBtn.titleLabel.font = [UIFont systemFontOfSize:15];
        [menuBtn setBackgroundImage:[UIImage imageNamed:@"select"] forState:UIControlStateSelected];
        menuBtn.tag = idx+1;
        [menuBtn addTarget:self action:@selector(btnAction:) forControlEvents:UIControlEventTouchUpInside];
        [self.view addSubview:menuBtn];
    }];
    
//    UIView *lastBtn = [self.view viewWithTag:_data.count-1];
    UIButton *plusBtn = [[UIButton alloc]initWithFrame:CGRectMake(60*SCREEN_SCALE, SCREEN_HEIGHT-180*SCREEN_SCALE, 40*SCREEN_SCALE, 40*SCREEN_SCALE)];
    [plusBtn setImage:[UIImage imageNamed:@"plus"] forState:UIControlStateNormal];
    [plusBtn addTarget:self action:@selector(addTarget) forControlEvents:UIControlEventTouchUpInside];
    [self.view addSubview:plusBtn];
    
    UIButton *settingBtn = [[UIButton alloc]initWithFrame:CGRectMake(20, SCREEN_HEIGHT-39, 50*SCREEN_SCALE, 19)];
    [settingBtn setImage:[UIImage imageNamed:@"setting"] forState:UIControlStateNormal];
    [settingBtn setTitle:@"设置" forState:UIControlStateNormal];
    settingBtn.titleLabel.font = [UIFont systemFontOfSize:12];
    [settingBtn addTarget:self action:@selector(settingActin) forControlEvents:UIControlEventTouchUpInside];
    settingBtn.titleLabel.tintColor = ColorAttionunCanBackground;
    [self.view addSubview:settingBtn];
    
    UIButton *nightBtn = [[UIButton alloc]initWithFrame:CGRectMake(CGRectGetMidX(settingBtn.frame)+30*SCREEN_SCALE, SCREEN_HEIGHT-39, settingBtn.width, settingBtn.height)];
    [nightBtn setImage:[UIImage imageNamed:@"night"] forState:UIControlStateNormal];
    [nightBtn setTitle:@"夜间" forState:UIControlStateNormal];
    nightBtn.titleLabel.font = [UIFont systemFontOfSize:12];
    nightBtn.titleLabel.tintColor = ColorAttionunCanBackground;
//    [self.view addSubview:nightBtn];

}

-(void)addItem:(NSString *)itemName atIndex:(NSInteger)index{
    [self reloadInputViews];
}

- (void)btnAction:(UIButton *)btn{
    selectBtn.selected = NO;
    selectBtn = btn;
    btn.selected = YES;
    NSDictionary *dic = _data[btn.tag-1];
    NSString *str = [dic valueForKey:@"class"];
     id class =  [[NSClassFromString(str) alloc]init];
    [[NSNotificationCenter defaultCenter]postNotificationName:MENU_NOTIFICATION object:class];
    NSLog(@"%@",[dic valueForKey:@"class"]);
}

- (void)addTarget{
    RYGAddTargetViewController *addTargetVC = [[RYGAddTargetViewController alloc]init];
    [[NSNotificationCenter defaultCenter]postNotificationName:MENU_NOTIFICATION object:addTargetVC];
}
- (void)userCenterAction{
    [[NSNotificationCenter defaultCenter]postNotificationName:USERCENTER_NOTIFICATION object:nil];
}
- (void)settingActin{
    RYGSettingViewController *settingVC = [[RYGSettingViewController alloc]init];
    [[NSNotificationCenter defaultCenter]postNotificationName:MENU_NOTIFICATION object:settingVC];
}
-(void)dealloc{
    [[NSNotificationCenter defaultCenter]removeObserver:self];
}

@end
