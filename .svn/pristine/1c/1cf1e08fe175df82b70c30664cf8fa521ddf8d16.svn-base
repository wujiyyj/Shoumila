
//  RYGArticleDetailView.m
//  shoumila
//
//  Created by 贾磊 on 16/4/9.
//  Copyright © 2016年 如意谷. All rights reserved.
//

#import "RYGArticleDetailView.h"
#import "RYGBarView.h"
#import "Masonry.h"
#import "UIImageView+RYGWebCache.h"

@interface RYGArticleDetailView ()<UIWebViewDelegate,UIScrollViewDelegate>
@property(nonatomic ,strong)UIImageView *avatarImageView;
@property(nonatomic ,strong)UIImageView *header_pic;
@property(nonatomic ,strong)UILabel *name;
@property(nonatomic ,strong)UILabel *publish_time;
@property(nonatomic ,strong)UILabel *level;
@property(nonatomic ,strong)RYGBarView *barView;
@property(nonatomic ,strong)UIWebView *webView;
@property(nonatomic ,strong)UIView *bgView;
@end

@implementation RYGArticleDetailView

- (instancetype)init{
    if (self = [super init]) {

        self.header_pic = [[UIImageView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 142*SCREEN_SCALE)];
        [self addSubview:self.header_pic];
        
        self.avatarImageView = [UIImageView new];
        [self addSubview:self.avatarImageView];
        self.avatarImageView.layer.cornerRadius = 4;
        self.avatarImageView.layer.masksToBounds = YES;
        [self.avatarImageView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.equalTo(self.header_pic.mas_bottom).offset(15);
            make.left.equalTo(self.mas_left).offset(15);
            make.width.mas_equalTo(@32);
            make.height.mas_equalTo(@32);
        }];
        
        self.name = [UILabel new];
        self.name.font = [UIFont systemFontOfSize:15];
        self.name.textColor = ColorName;
        [self addSubview:self.name];
        [self.name mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.equalTo(self.header_pic.mas_bottom).offset(15);
            make.left.equalTo(self.avatarImageView.mas_right).offset(10);
            make.height.mas_equalTo(@16);
        }];
        
        self.level = [UILabel new];
        self.level.textColor = ColorYeallow;
        self.level.font = [UIFont systemFontOfSize:12];
        [self addSubview:self.level];
        [self.level mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.equalTo(self.name.mas_right).offset(5);
            make.top.equalTo(self.header_pic.mas_bottom).offset(15);
            make.height.mas_equalTo(@16);
        }];
        self.publish_time = [UILabel new];
        self.publish_time.font = [UIFont systemFontOfSize:10];
        self.publish_time.textColor = ColorRankMedal;
        [self addSubview:self.publish_time];
        [self.publish_time mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.equalTo(self.name.mas_bottom).offset(7);
            make.left.equalTo(self.avatarImageView.mas_right).offset(10);
            make.height.mas_equalTo(@11);
        }];
    
        self.webView = [UIWebView new];
        self.webView.scrollView.delegate = self;
        [self addSubview:self.webView];
        self.webView.delegate = self;
        [self.webView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.top.equalTo(self.avatarImageView.mas_bottom).offset(15);
            make.left.mas_equalTo(0);
            make.right.mas_equalTo(0);
            make.height.mas_equalTo(200);
        }];
        self.barView = [[RYGBarView alloc]initWithFrame:CGRectMake(0, 0, 200, 20)];
        
        self.bgView = [[UIView alloc]initWithFrame:CGRectMake(0, 100, SCREEN_WIDTH, 20)];
        self.bgView.backgroundColor = [UIColor whiteColor];
        [self.bgView addSubview:self.barView];
        [self addSubview:self.bgView];
    }
    return self;
}

-(void)setDynamicModel:(RYGDynamicFrame *)dynamicFrame{
    RYGDynamicModel *dynamicModel = dynamicFrame.dynamicModel;
    [self.header_pic setImageURLStr:dynamicModel.article.header_pic placeholder:[UIImage imageNamed:@"user_head"]];
    self.name.text = dynamicModel.publish_user.name;
    self.level.text = [NSString stringWithFormat:@"Lv.%@", dynamicModel.publish_user.grade];
    self.publish_time.text = dynamicModel.publish_time;
    [self.avatarImageView setImageURLStr:dynamicModel.publish_user.avatar placeholder:nil];
    [self.webView loadHTMLString:dynamicModel.article.article_content baseURL:nil];
    self.barView.dynamicFrame = dynamicFrame;
    [self layoutIfNeeded];
    self.frame = CGRectMake(0, 0, SCREEN_WIDTH, self.barView.top + 30);
}
- (void)webViewDidFinishLoad:(UIWebView *)webView{
    CGFloat height = [[webView stringByEvaluatingJavaScriptFromString:@"document.body.offsetHeight"] floatValue];
    [self.webView mas_remakeConstraints:^(MASConstraintMaker *make) {
        make.top.equalTo(self.avatarImageView.mas_bottom).offset(15);
        make.left.mas_equalTo(0);
        make.right.mas_equalTo(0);
        make.height.mas_equalTo(height);
    }];
    self.bgView.top = height+228;
    self.barView.top = self.bgView.top;
    [self addSubview:_barView];
    height +=260;
    [[NSNotificationCenter defaultCenter]postNotificationName:@"headerViewHeightChange" object:@(height)];
}

-(void)scrollViewDidScroll:(UIScrollView *)scrollView
{
    CGPoint point = scrollView.contentOffset;
    CGFloat contentHeight = scrollView.contentSize.height;
    CGFloat frameHeight   = scrollView.frame.size.height;
    
    if(point.y < 0)
    {
        [scrollView setContentOffset:CGPointMake(point.x, 0) animated:NO];
    }
    else if(contentHeight > frameHeight)
    {
        if(contentHeight - point.y < frameHeight)
        {
            [scrollView setContentOffset:CGPointMake(point.x, contentHeight - frameHeight) animated:NO];
        }
    }
    else if(contentHeight <= frameHeight)
    {
        [scrollView setContentOffset:CGPointMake(point.x, 0) animated:NO];
    }
    
}
@end
